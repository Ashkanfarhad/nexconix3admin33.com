<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NexCoinX Admin</title>
<script>
(function(){
  function tryLoad(urls, idx){
    if(idx>=urls.length){window._lwcFailed=true;return;}
    var s=document.createElement('script');
    s.src=urls[idx];
    s.onload=function(){window._lwcLoaded=true;};
    s.onerror=function(){tryLoad(urls,idx+1);};
    document.head.appendChild(s);
  }
  tryLoad([
    'https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js',
    'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js',
    'https://cdnjs.cloudflare.com/ajax/libs/lightweight-charts/4.1.1/lightweight-charts.standalone.production.js'
  ], 0);
})();
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
:root{--bg:#060a12;--bg2:#0a1020;--bg3:#0e1628;--bg4:#131e30;--b1:rgba(255,255,255,.065);--b2:rgba(255,255,255,.1);--ye:#f0b90b;--ye2:#f8d12f;--gr:#0ecb81;--re:#f6465d;--bl:#1890ff;--vt:#9b59b6;--tx:#eaecef;--t2:#b7bdc6;--t3:#707a8a;--t4:#3d4d5e;--mn:'IBM Plex Mono',monospace;--sn:'Plus Jakarta Sans',sans-serif;--r:7px;--r2:11px;}
*{margin:0;padding:0;box-sizing:border-box;}html{font-size:14px;}
body{font-family:var(--sn);background:var(--bg);color:var(--tx);min-height:100vh;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--b2);border-radius:99px;}
.btn{padding:8px 17px;border-radius:var(--r);font-family:var(--sn);font-size:.83rem;font-weight:600;cursor:pointer;border:none;transition:.18s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;}
.btn-ye{background:var(--ye);color:#060a12;}.btn-ye:hover{background:var(--ye2);}
.btn-gh{background:transparent;border:1px solid var(--b2);color:var(--t2);}.btn-gh:hover{color:var(--tx);}
.btn-gr{background:rgba(14,203,129,.1);border:1px solid rgba(14,203,129,.22);color:var(--gr);}
.btn-re{background:rgba(246,70,93,.1);border:1px solid rgba(246,70,93,.22);color:var(--re);}
.btn-bl{background:rgba(24,144,255,.1);border:1px solid rgba(24,144,255,.22);color:var(--bl);}
.btn-sm{padding:5px 12px;font-size:.78rem;}.btn-xs{padding:4px 9px;font-size:.72rem;}.btn-full{width:100%;justify-content:center;}
.fg{margin-bottom:12px;}.fg label{display:block;font-size:.68rem;text-transform:uppercase;letter-spacing:.06em;color:var(--t3);margin-bottom:5px;}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 13px;background:var(--bg);border:1px solid var(--b1);border-radius:var(--r);color:var(--tx);font-family:var(--sn);font-size:.875rem;outline:none;transition:.18s;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--ye);}
.fg select option{background:var(--bg2);}.fg textarea{resize:vertical;min-height:70px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
#auth-scr{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:radial-gradient(ellipse 70% 50% at 50% 0%,rgba(240,185,11,.05) 0%,transparent 60%);}
.auth-box{background:var(--bg2);border:1px solid var(--b2);border-radius:var(--r2);padding:40px;width:100%;max-width:380px;text-align:center;}
.auth-logo{font-family:var(--mn);font-size:1.4rem;font-weight:600;display:flex;align-items:center;justify-content:center;gap:7px;margin-bottom:4px;}
.auth-logo .dot{width:9px;height:9px;border-radius:50%;background:var(--ye);}
.admin-badge{background:rgba(246,70,93,.12);color:var(--re);font-size:.65rem;padding:2px 7px;border-radius:99px;font-weight:700;letter-spacing:.04em;margin-inline-start:6px;vertical-align:middle;}
#admin-app{display:none;}
.wrap{display:grid;grid-template-columns:210px 1fr;min-height:100vh;}
.sidebar{background:var(--bg2);border-inline-end:1px solid var(--b1);position:sticky;top:0;height:100vh;overflow-y:auto;display:flex;flex-direction:column;}
.sb-hd{padding:18px 14px;border-bottom:1px solid var(--b1);}
.sb-logo{font-family:var(--mn);font-size:1rem;font-weight:600;}.sb-logo .c{color:var(--ye);}
.on-row{display:flex;align-items:center;gap:5px;margin-top:7px;font-size:.75rem;color:var(--t3);}
.on-dot{width:6px;height:6px;border-radius:50%;background:var(--gr);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(1.4);}}
.sb-nav{padding:10px 8px;flex:1;}
.sbg{margin-bottom:20px;}
.sbl{font-size:.62rem;text-transform:uppercase;letter-spacing:.1em;color:var(--t4);padding:0 8px;margin-bottom:5px;}
.sbk{display:flex;align-items:center;gap:8px;padding:8px 8px;border-radius:var(--r);cursor:pointer;color:var(--t3);font-size:.83rem;font-weight:500;transition:.16s;margin-bottom:1px;}
.sbk:hover{background:var(--bg3);color:var(--tx);}.sbk.on{background:rgba(240,185,11,.07);color:var(--ye);}
.sbk svg{width:13px;height:13px;flex-shrink:0;}
.sb-badge{margin-inline-start:auto;background:var(--re);color:#fff;font-size:.6rem;padding:1px 6px;border-radius:99px;font-weight:700;}
.main-col{display:flex;flex-direction:column;}
.topbar{background:var(--bg2);border-bottom:1px solid var(--b1);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.page-ttl{font-weight:700;font-size:.95rem;}
.tb-r{display:flex;align-items:center;gap:8px;}
.on-chip{background:rgba(14,203,129,.07);border:1px solid rgba(14,203,129,.18);color:var(--gr);font-size:.75rem;padding:4px 11px;border-radius:99px;}
.content{padding:22px 26px;flex:1;}
.pg{display:none;}.pg.on{display:block;}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:11px;margin-bottom:18px;}
.kpi{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);padding:16px;}
.kpi .lbl{color:var(--t3);font-size:.68rem;text-transform:uppercase;letter-spacing:.05em;margin-bottom:5px;}
.kpi .val{font-family:var(--mn);font-size:1.3rem;font-weight:600;}
.sec-box{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);overflow:hidden;margin-bottom:14px;}
.sec-hdr{padding:12px 17px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;}
.sec-ttl{font-weight:700;font-size:.9rem;}
table{width:100%;border-collapse:collapse;}
th{text-align:start;padding:9px 17px;font-size:.65rem;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);border-bottom:1px solid var(--b1);font-weight:500;}
td{padding:10px 17px;border-bottom:1px solid rgba(255,255,255,.02);font-size:.82rem;vertical-align:middle;}
tr:last-child td{border-bottom:none;}tr:hover td{background:rgba(255,255,255,.01);}
.badge{display:inline-block;padding:2px 8px;border-radius:3px;font-size:.67rem;font-weight:700;font-family:var(--mn);}
.bg{background:rgba(14,203,129,.1);color:var(--gr);}.br{background:rgba(246,70,93,.1);color:var(--re);}.bo{background:rgba(240,185,11,.1);color:var(--ye);}.bb{background:rgba(24,144,255,.1);color:var(--bl);}
.ovl{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:400;align-items:center;justify-content:center;backdrop-filter:blur(9px);padding:18px;}
.ovl.show{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--b2);border-radius:var(--r2);width:100%;max-width:500px;max-height:92vh;overflow-y:auto;position:relative;animation:mu .2s ease;}
@keyframes mu{from{transform:translateY(9px);opacity:0}to{transform:translateY(0);opacity:1}}
.mhdr{padding:15px 17px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;}
.mhdr h3{font-weight:700;font-size:.92rem;}
.mclose{width:25px;height:25px;border-radius:5px;background:var(--bg3);border:1px solid var(--b1);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--t3);font-size:.8rem;transition:.14s;}
.mclose:hover{color:var(--tx);}
.mbody{padding:17px;}
.coin-prev{background:var(--bg3);border:1px solid var(--b1);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:13px;margin-bottom:16px;}
.prev-ic{width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.icon-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:5px;background:var(--bg);border-radius:var(--r);padding:9px;max-height:160px;overflow-y:auto;}
.ico{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;border:2px solid transparent;transition:.13s;}
.ico:hover,.ico.sel{border-color:var(--ye);background:rgba(240,185,11,.06);}
.clr-row{display:flex;gap:7px;flex-wrap:wrap;}
.clr{width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:.13s;flex-shrink:0;}
.clr:hover,.clr.sel{border-color:#fff;transform:scale(1.15);}
.chart-ctrl{display:grid;grid-template-columns:1fr 310px;gap:16px;align-items:start;}
.chart-panel{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);overflow:hidden;}
.c-topbar{padding:12px 16px;border-bottom:1px solid var(--b1);display:flex;align-items:center;gap:9px;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--gr);animation:pulse 1.5s infinite;}
.ctrl-pnl{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);padding:18px;}
.ctrl-pnl h4{font-weight:700;margin-bottom:14px;font-size:.9rem;}
.price-disp{background:var(--bg3);border-radius:var(--r);padding:13px;text-align:center;margin-bottom:14px;}
.price-disp .big{font-family:var(--mn);font-size:1.8rem;font-weight:600;color:var(--ye);}
.qbtns{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:10px;}
.coins-admin-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;}
.cac{background:var(--bg2);border:1px solid var(--b1);border-radius:var(--r2);padding:16px;transition:.16s;}
.cac:hover{border-color:rgba(240,185,11,.2);}
.sum-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b1);font-size:.82rem;}
.sum-row:last-child{border-bottom:none;}.sum-row .sk{color:var(--t3);}
.msg-layout-admin{display:grid;grid-template-columns:240px 1fr;height:calc(100vh - 56px);}
.msg-list-admin{background:var(--bg2);border-inline-end:1px solid var(--b1);overflow-y:auto;}
.mla-hdr{padding:12px 14px;border-bottom:1px solid var(--b1);font-weight:700;font-size:.88rem;}
.mla-item{padding:11px 13px;border-bottom:1px solid rgba(255,255,255,.02);cursor:pointer;transition:.16s;display:flex;gap:8px;align-items:flex-start;}
.mla-item:hover{background:var(--bg3);}.mla-item.on{background:rgba(240,185,11,.04);}
.mla-item.unread .mla-name{color:var(--ye);}
.mla-av{width:32px;height:32px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;flex-shrink:0;}
.mla-name{font-weight:600;font-size:.8rem;margin-bottom:2px;}
.mla-prev{color:var(--t3);font-size:.7rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px;}
.mla-time{color:var(--t4);font-size:.62rem;margin-inline-start:auto;white-space:nowrap;}
.msg-chat-admin{display:flex;flex-direction:column;background:var(--bg);}
.mca-hdr{padding:12px 16px;border-bottom:1px solid var(--b1);background:var(--bg2);display:flex;align-items:center;gap:9px;}
.mca-av{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,rgba(240,185,11,.2),rgba(240,185,11,.4));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;}
.mca-name{font-weight:700;font-size:.88rem;}.mca-email{color:var(--t3);font-size:.7rem;}
.mca-body{flex:1;overflow-y:auto;padding:13px 16px;display:flex;flex-direction:column;gap:8px;}
.bubble{max-width:68%;padding:8px 12px;border-radius:9px;font-size:.83rem;line-height:1.5;word-break:break-word;}
.bubble.adm-sent{background:rgba(240,185,11,.09);border:1px solid rgba(240,185,11,.18);align-self:flex-end;border-end-end-radius:2px;}
.bubble.adm-sent::before{content:'You (Admin)';display:block;color:var(--ye);font-size:.6rem;font-weight:700;margin-bottom:3px;text-transform:uppercase;}
.bubble.user-sent{background:var(--bg3);border:1px solid var(--b1);align-self:flex-start;border-end-start-radius:2px;}
.btime{font-size:.6rem;color:var(--t4);margin-top:3px;text-align:end;}
.mca-foot{padding:11px 16px;border-top:1px solid var(--b1);background:var(--bg2);display:flex;gap:7px;align-items:flex-end;}
.mca-foot textarea{flex:1;padding:8px 11px;background:var(--bg3);border:1px solid var(--b1);border-radius:var(--r);color:var(--tx);font-family:var(--sn);font-size:.83rem;resize:none;outline:none;max-height:90px;transition:.16s;}
.mca-foot textarea:focus{border-color:var(--ye);}
.no-sel{display:flex;align-items:center;justify-content:center;flex:1;color:var(--t4);flex-direction:column;gap:8px;}
.toast{position:fixed;top:65px;inset-inline-end:16px;z-index:9999;background:var(--bg2);border:1px solid var(--b2);border-radius:var(--r);padding:10px 14px;display:flex;align-items:center;gap:7px;box-shadow:0 8px 22px rgba(0,0,0,.5);transform:translateX(130%);transition:transform .24s ease;max-width:290px;font-size:.82rem;}
.toast.show{transform:translateX(0);}
@media(max-width:900px){
  .wrap{grid-template-columns:1fr;}
  .sidebar{display:none;}
  .content{padding:12px;}
  .kpi-row{grid-template-columns:repeat(2,1fr);}
  .form-row{grid-template-columns:1fr;}
  .chart-ctrl{grid-template-columns:1fr;}
  .msg-layout-admin{grid-template-columns:1fr;height:auto;}
  .msg-list-admin{max-height:280px;}
  .msg-chat-admin{min-height:400px;}
  table{font-size:.75rem;}
  th,td{padding:7px 10px;}
}
@media(max-width:600px){
  .kpi-row{grid-template-columns:1fr 1fr;}
  .top-bar{flex-wrap:wrap;gap:8px;}
  .top-bar h2{font-size:.9rem;}
  .mhdr h3{font-size:.88rem;}
}
</style>
</head>
<body>
<div id="auth-scr">
 <div class="auth-box">
  <div style="font-size:2.5rem;margin-bottom:12px;">&#128737;&#65039;</div>
  <div class="auth-logo"><div class="dot"></div>NexCoinX <span class="admin-badge">ADMIN</span></div>
  <p style="color:#707a8a;font-size:.85rem;margin:6px 0 24px;">Control Panel &mdash; Authorized Access Only</p>
  <div class="fg"><label>Username</label><input id="au" placeholder="admin" onkeydown="if(event.key==='Enter')aLogin()"/></div>
  <div class="fg"><label>Password</label><input type="password" id="ap" placeholder="Password" onkeydown="if(event.key==='Enter')aLogin()"/></div>
  <button class="btn btn-ye btn-full" style="padding:11px;margin-top:4px;" onclick="aLogin()">Enter Dashboard</button>
  <p style="margin-top:12px;color:#3d4d5e;font-size:.72rem;">Default: admin / admin123</p>
 </div>
</div>

<div id="admin-app">
<div class="wrap">
<aside class="sidebar">
 <div class="sb-hd">
  <div class="sb-logo">Nex<span class="c">CoinX</span> <span class="admin-badge">ADMIN</span></div>
  <div class="on-row"><span class="on-dot"></span><span id="on-txt">0 online</span></div>
 </div>
 <div class="sb-nav">
  <div class="sbg">
   <div class="sbl">Overview</div>
   <div class="sbk on" onclick="goPg('dashboard',this)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</div>
   <div class="sbk" onclick="goPg('deposits',this)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Deposits <span class="sb-badge" id="dep-badge" style="display:none;"></span></div>
   <div class="sbk" onclick="goPg('transactions',this)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m16 3 4 4-4 4M8 21l-4-4 4-4M20 7H4M20 17H4"/></svg>Transactions</div>
  </div>
  <div class="sbg">
   <div class="sbl">Coins</div>
   <div class="sbk" onclick="goPg('coins',this)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M14.8 9A2 2 0 0 0 13 8h-2a2 2 0 0 0 0 4h2a2 2 0 0 1 0 4h-2a2 2 0 0 1-1.8-1"/><path d="M12 7v1m0 8v1"/></svg>Manage Coins</div>
   <div class="sbk" onclick="goPg('price',this)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>Price Control</div>
  </div>
  <div class="sbg">
   <div class="sbl">Users &amp; Comms</div>
   <div class="sbk" onclick="goPg('users',this)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="7" r="4"/><path d="M1 21c0-4 3.6-7 8-7"/><circle cx="17" cy="11" r="3"/><path d="M17 14c2.8 0 5 1.8 5 4"/></svg>Users</div>
   <div class="sbk" onclick="goPg('messages',this)"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Messages <span class="sb-badge" id="amsg-badge" style="display:none;"></span></div>
  </div>
 </div>
</aside>
<div class="main-col">
 <div class="topbar">
  <div class="page-ttl" id="pg-ttl">Dashboard</div>
  <div class="tb-r">
   <div class="on-chip">&#x1F7E2; <span id="on-top">0</span> online</div>
   <button class="btn btn-gh btn-sm" onclick="refreshAll()">&#8635; Refresh</button>
   <button class="btn btn-re btn-sm" onclick="aLogout()">Sign Out</button>
  </div>
 </div>
 <div class="content">

  <div class="pg on" id="pg-dashboard">
   <div class="kpi-row" id="kpi-row"></div>
   <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
    <div class="sec-box">
     <div class="sec-hdr"><div class="sec-ttl">Pending Deposits</div></div>
     <table><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Action</th></tr></thead><tbody id="dash-pend"></tbody></table>
    </div>
    <div class="sec-box">
     <div class="sec-hdr"><div class="sec-ttl">Recent Trades</div></div>
     <table><thead><tr><th>User</th><th>Coin</th><th>Type</th><th>USD</th></tr></thead><tbody id="dash-trades"></tbody></table>
    </div>
   </div>
  </div>

  <div class="pg" id="pg-deposits">
   <div class="sec-box">
    <div class="sec-hdr"><div class="sec-ttl">All Deposit Requests</div><span style="font-size:.75rem;color:var(--t3);">Approve to credit balance &amp; auto-notify user</span></div>
    <table><thead><tr><th>User</th><th>Phone</th><th>Method</th><th>Amount</th><th>Receipt</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody id="all-deps-body"></tbody></table>
   </div>
  </div>

  <div class="pg" id="pg-transactions">
   <div class="sec-box">
    <div class="sec-hdr"><div class="sec-ttl">All Transactions</div></div>
    <table><thead><tr><th>User</th><th>Coin</th><th>Type</th><th>Coins</th><th>USD</th><th>Price</th><th>Date</th></tr></thead><tbody id="all-tx-body"></tbody></table>
   </div>
  </div>

  <div class="pg" id="pg-coins">
   <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
    <div style="font-weight:700;font-size:.95rem;">Coins Manager</div>
    <button class="btn btn-ye" onclick="openCoinModal()">+ Create Coin</button>
   </div>
   <div class="coins-admin-grid" id="coins-admin-grid"></div>
  </div>

  <div class="pg" id="pg-price">
   <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
    <div class="fg" style="margin:0;flex:1;max-width:260px;">
     <label>Select Coin</label>
     <select id="price-sel" onchange="loadPriceCtrl()"></select>
    </div>
   </div>
   <div class="chart-ctrl">
    <div class="chart-panel">
     <div class="c-topbar">
      <div class="live-dot"></div>
      <span id="pc-name" style="font-weight:700;font-size:.88rem;">Select a coin</span>
      <span id="pc-price" style="color:var(--ye);margin-inline-start:auto;font-family:var(--mn);font-weight:700;font-size:1rem;"></span>
     </div>
     <div id="admin-chart" style="height:380px;"></div>
    </div>
    <div class="ctrl-pnl">
     <h4>Price Control</h4>
     <div class="price-disp">
      <div style="color:var(--t3);font-size:.68rem;margin-bottom:3px;">CURRENT PRICE</div>
      <div class="big" id="ctrl-big">--</div>
     </div>
     <div class="fg">
      <label>New Price (max &plusmn;$0.10)</label>
      <input type="number" id="ctrl-np" step="0.0001" placeholder="0.0000"/>
     </div>
     <button class="btn btn-ye btn-full" onclick="setAdminPrice()" style="margin-bottom:8px;">Set Price + Update Chart</button>
     <div class="qbtns">
      <button class="btn btn-gr" onclick="qMove('up','s')">+Small</button>
      <button class="btn btn-re" onclick="qMove('dn','s')">&minus;Small</button>
      <button class="btn btn-gr" onclick="qMove('up','m')">Pump &#x1F4C8;</button>
      <button class="btn btn-re" onclick="qMove('dn','m')">Dump &#x1F4C9;</button>
     </div>
     <div style="background:rgba(240,185,11,.05);border:1px solid rgba(240,185,11,.16);border-radius:var(--r);padding:10px;margin-top:12px;font-size:.75rem;color:#fbbf24;line-height:1.5;">Each price update creates a new live point on the line chart visible to users instantly.</div>
    </div>
   </div>
  </div>

  <div class="pg" id="pg-users">
   <div class="sec-box">
    <div class="sec-hdr"><div class="sec-ttl">Registered Users</div><span id="users-badge" class="badge bb">0</span></div>
    <table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Balance</th><th>Joined</th><th>Actions</th></tr></thead><tbody id="users-body"></tbody></table>
   </div>
  </div>

  <div class="pg" id="pg-messages">
   <div class="msg-layout-admin">
    <div class="msg-list-admin">
     <div class="mla-hdr">User Conversations</div>
     <div id="admin-msg-list"><div style="padding:16px;color:var(--t4);font-size:.83rem;text-align:center;">No messages yet</div></div>
    </div>
    <div class="msg-chat-admin" id="admin-msg-chat">
     <div class="no-sel"><div style="font-size:1.6rem;">&#128172;</div><div>Select a user to reply</div></div>
    </div>
   </div>
  </div>

 </div>
</div>
</div>
</div>

<!-- COIN MODAL -->
<div class="ovl" id="coin-ovl">
<div class="modal">
 <div class="mhdr"><h3 id="coin-modal-ttl">Create New Coin</h3><div class="mclose" onclick="closeCoinModal()">X</div></div>
 <div class="mbody">
  <div class="coin-prev"><div class="prev-ic" id="prev-ic">&#8383;</div><div><div style="font-weight:800;font-size:.95rem;" id="prev-nm">My Coin</div><div style="color:var(--t3);font-size:.75rem;" id="prev-sy">MYC</div></div><div style="margin-inline-start:auto;font-family:var(--mn);font-weight:700;color:var(--ye);" id="prev-pr">$0.0100</div></div>
  <div class="form-row">
   <div class="fg"><label>Name *</label><input id="cn-nm" placeholder="CoinName" oninput="updPrev()"/></div>
   <div class="fg"><label>Symbol * (2-6)</label><input id="cn-sy" placeholder="SYM" maxlength="6" oninput="updPrev()"/></div>
  </div>
  <div class="form-row">
   <div class="fg"><label>Initial Price ($)</label><input type="number" id="cn-pr" value="0.0100" step="0.0001" oninput="updPrev()"/></div>
   <div class="fg"><label>Total Supply</label><input type="number" id="cn-sup" value="10000000"/></div>
  </div>
  <div class="fg"><label>Icon</label><div class="icon-grid" id="icon-grid"></div></div>
  <div class="fg"><label>Color</label><div class="clr-row" id="clr-row"></div></div>
  <div style="display:flex;gap:8px;margin-top:6px;">
   <button class="btn btn-ye" style="flex:1;" onclick="saveCoin()"><span id="coin-save-lbl">Launch Coin</span></button>
   <button class="btn btn-gh" onclick="closeCoinModal()">Cancel</button>
  </div>
  <input type="hidden" id="cn-edit-id"/>
 </div>
</div>
</div>

<!-- DEPOSIT VIEW MODAL -->
<div class="ovl" id="dep-view-ovl">
<div class="modal">
 <div class="mhdr"><h3>Deposit Details</h3><div class="mclose" onclick="document.getElementById('dep-view-ovl').classList.remove('show')">X</div></div>
 <div class="mbody" id="dep-view-body"></div>
</div>
</div>

<!-- EDIT USER MODAL -->
<div class="ovl" id="ue-ovl">
<div class="modal" style="max-width:400px;">
 <div class="mhdr"><h3>Edit User</h3><div class="mclose" onclick="document.getElementById('ue-ovl').classList.remove('show')">X</div></div>
 <div class="mbody">
  <input type="hidden" id="ue-id"/>
  <div class="fg"><label>Name</label><input id="ue-name"/></div>
  <div class="fg"><label>Email</label><input type="email" id="ue-email"/></div>
  <div class="fg"><label>Phone</label><input type="tel" id="ue-phone"/></div>
  <div class="fg"><label>Balance ($)</label><input type="number" id="ue-bal" step="0.01"/></div>
  <button class="btn btn-ye btn-full" onclick="saveUserEdit()">Save Changes</button>
 </div>
</div>
</div>

<div class="toast" id="toast"><span id="tic">OK</span> <span id="tmsg"></span></div>

<script>
const DB={
 get(){return JSON.parse(localStorage.getItem('ncx_db')||'null')||DB.def();},
 save(d){localStorage.setItem('ncx_db',JSON.stringify(d));},
 def(){return{coins:[{id:'btcx',name:'BitcoinX',symbol:'BTCX',price:.08,supply:21000000,color:'#f0b90b',icon:'\u20BF',candles:[]},{id:'ethx',name:'EtherX',symbol:'ETHX',price:.05,supply:10000000,color:'#818cf8',icon:'\u2B21',candles:[]},{id:'slrx',name:'SolarX',symbol:'SLRX',price:.032,supply:50000000,color:'#0ecb81',icon:'\u2600',candles:[]}],users:[],deposits:[],transactions:[],messages:[]};},
 getUsers(){return JSON.parse(localStorage.getItem('ncx_users')||'[]');},
 saveUsers(u){localStorage.setItem('ncx_users',JSON.stringify(u));}
};
function ensureC(c){if(!c.candles||!c.candles.length){const now=Math.floor(Date.now()/1000);const p=c.price;c.candles=[];for(let i=0;i<12;i++){const t=now-(12-i)*1800;const v=p*(.94+Math.random()*.12);c.candles.push({time:t,value:v});}c.candles[11].value=p;}}
let ALC=null,ALS=null,selCoinId=null,newIco='\u20BF',newClr='#f0b90b',editingCoinId=null,pollInt=null,activeMsgUser=null;
const ICONS=['\u20BF','\u2B21','\u2600','\uD83D\uDD25','\u26A1','\uD83C\uDF0A','\uD83C\uDF19','\u2B50','\uD83D\uDC8E','\uD83D\uDD2E','\uD83D\uDEF8','\uD83C\uDF0C','\u269B','\uD83E\uDDEC','\uD83D\uDCA1','\uD83C\uDF08','\u2744\uFE0F','\uD83C\uDFAF','\uD83D\uDE80','\uD83E\uDD8B','\uD83D\uDC09','\uD83E\uDD85','\u2694','\uD83D\uDEE1','\uD83C\uDFC6','\uD83D\uDCB0','\uD83D\uDD11','\u267E','\uD83C\uDF00','\uD83D\uDD36','\uD83D\uDD37','\uD83C\uDFC5','\uD83C\uDF20','\uD83C\uDF0B','\uD83E\uDD8A','\uD83D\uDCE1'];
const COLORS=['#f0b90b','#818cf8','#0ecb81','#f6465d','#00e5ff','#7c3aed','#f97316','#ec4899','#14b8a6','#84cc16','#6366f1','#a855f7','#0ea5e9','#d97706','#059669'];

function aLogin(){if(gv('au')==='admin'&&gv('ap')==='admin123'){document.getElementById('auth-scr').style.display='none';document.getElementById('admin-app').style.display='block';initAdmin();}else t('X','Wrong credentials');}
function aLogout(){document.getElementById('auth-scr').style.display='flex';document.getElementById('admin-app').style.display='none';if(pollInt)clearInterval(pollInt);}
function initAdmin(){buildIconGrid();buildClrRow();refreshAll();if(pollInt)clearInterval(pollInt);pollInt=setInterval(()=>{refreshAll();if(selCoinId&&document.getElementById('pg-price').classList.contains('on'))pollChart();},2800);}
function refreshAll(){const db=DB.get();renderKPIs(db);renderDashPend(db);renderDashTrades(db);renderDepsPage(db);renderTxPage(db);renderCoinsPage(db);renderUsersPage();populatePriceSel(db);chkAdminMsgs(db);if(document.getElementById('pg-messages').classList.contains('on'))renderAdminMsgs();const pend=(db.deposits||[]).filter(d=>d.status==='pending').length;const dep=document.getElementById('dep-badge');if(dep){dep.textContent=pend;dep.style.display=pend>0?'':'none';}const us=DB.getUsers();const on=us.length>0?Math.min(us.length,Math.ceil(us.length*.6)+1):0;document.getElementById('on-txt').textContent=on+' online';document.getElementById('on-top').textContent=on;}
function showBroadcastPanel(){const p=document.getElementById('broadcast-panel');p.style.display=p.style.display==='none'?'block':'none';}
function sendBroadcast(){const txt=document.getElementById('broadcast-txt').value.trim();if(!txt)return toast('⚠️','Enter a message');const us=DB.getUsers();if(!us.length)return toast('⚠️','No users yet');const db=DB.get();db.messages=db.messages||[];const now=new Date().toISOString();us.forEach(u=>{db.messages.push({id:'msg_'+Date.now()+'_'+u.id,fromUserId:'admin',fromName:'Admin',toUserId:u.id,fromAdmin:true,text:txt,date:now,readByUser:false,readByAdmin:true});});DB.save(db);document.getElementById('broadcast-txt').value='';document.getElementById('broadcast-panel').style.display='none';toast('✅',`Broadcast sent to ${us.length} user${us.length>1?'s':''}!`);renderAdminMsgs();}
function chkAdminMsgs(db){const n=(db.messages||[]).filter(m=>m.toUserId==='admin'&&!m.readByAdmin).length;const b=document.getElementById('amsg-badge');if(b){b.textContent=n;b.style.display=n>0?'':'none';}}
function goPg(p,el){document.querySelectorAll('.pg').forEach(e=>e.classList.remove('on'));document.querySelectorAll('.sbk').forEach(e=>e.classList.remove('on'));document.getElementById('pg-'+p).classList.add('on');if(el)el.classList.add('on');const titles={dashboard:'Dashboard',deposits:'Deposits',transactions:'Transactions',coins:'Coins Manager',price:'Price Control',users:'Users',messages:'Messages'};document.getElementById('pg-ttl').textContent=titles[p]||p;if(p==='price')loadPriceCtrl();if(p==='messages')renderAdminMsgs();}
function renderKPIs(db){const us=DB.getUsers();const appDep=(db.deposits||[]).filter(d=>d.status==='approved').reduce((s,d)=>s+d.amount,0);const vol=(db.transactions||[]).reduce((s,tx)=>s+tx.usdAmt,0);const pend=(db.deposits||[]).filter(d=>d.status==='pending').length;document.getElementById('kpi-row').innerHTML=`<div class="kpi"><div class="lbl">Users</div><div class="val">${us.length}</div></div><div class="kpi"><div class="lbl">Approved Deposits</div><div class="val" style="color:var(--gr);">$${appDep.toFixed(0)}</div></div><div class="kpi"><div class="lbl">Trade Volume</div><div class="val">$${vol.toFixed(0)}</div></div><div class="kpi"><div class="lbl">Pending</div><div class="val" style="color:var(--ye);">${pend}</div></div><div class="kpi"><div class="lbl">Coins</div><div class="val" style="color:#818cf8;">${(db.coins||[]).length}</div></div>`;}
function renderDashPend(db){const pend=(db.deposits||[]).filter(d=>d.status==='pending').slice(-5).reverse();document.getElementById('dash-pend').innerHTML=!pend.length?'<tr><td colspan="4" style="color:var(--t3);padding:13px;text-align:center;">No pending deposits</td></tr>':pend.map(d=>`<tr><td><strong>${d.userName}</strong></td><td style="color:var(--ye);font-family:var(--mn);font-weight:700;">$${d.amount}</td><td><span class="badge bb">${d.method==='fastpay'?'FastPay':'FIB'}</span></td><td style="display:flex;gap:4px;flex-wrap:wrap;"><button class="btn btn-gr btn-xs" onclick="appDep('${d.id}')">Approve</button><button class="btn btn-re btn-xs" onclick="rejDep('${d.id}')">Reject</button><button class="btn btn-bl btn-xs" onclick="viewDep('${d.id}')">View</button></td></tr>`).join('');}
function renderDashTrades(db){const txs=(db.transactions||[]).slice(-6).reverse();document.getElementById('dash-trades').innerHTML=!txs.length?'<tr><td colspan="4" style="color:var(--t3);padding:13px;text-align:center;">No trades yet</td></tr>':txs.map(tx=>`<tr><td>${tx.userName}</td><td>${tx.coinName}</td><td><span class="badge ${tx.type==='buy'?'bg':'br'}">${tx.type.toUpperCase()}</span></td><td style="font-family:var(--mn);">$${tx.usdAmt.toFixed(2)}</td></tr>`).join('');}
function renderDepsPage(db){const deps=(db.deposits||[]).slice().reverse();document.getElementById('all-deps-body').innerHTML=!deps.length?'<tr><td colspan="8" style="color:var(--t3);padding:13px;text-align:center;">No deposits</td></tr>':deps.map(d=>`<tr><td><strong>${d.userName}</strong><br><span style="color:var(--t3);font-size:.7rem;">${d.userEmail||''}</span></td><td>${d.phone}</td><td><span class="badge bb">${d.method==='fastpay'?'Fast Pay':'FIB'}</span></td><td style="color:var(--ye);font-family:var(--mn);font-weight:700;">$${d.amount}</td><td>${d.docData?`<button class="btn btn-bl btn-xs" onclick="viewDep('${d.id}')">View Receipt</button>`:'<span style="color:var(--t4);">none</span>'}</td><td style="color:var(--t3);font-size:.73rem;">${new Date(d.date).toLocaleString()}</td><td><span class="badge ${d.status==='pending'?'bo':d.status==='approved'?'bg':'br'}">${d.status==='pending'?'Pending':d.status==='approved'?'Approved':'Rejected'}</span></td><td style="display:flex;gap:4px;flex-wrap:wrap;">${d.status==='pending'?`<button class="btn btn-gr btn-xs" onclick="appDep('${d.id}')">Approve</button><button class="btn btn-re btn-xs" onclick="rejDep('${d.id}')">Reject</button>`:''}<button class="btn btn-gh btn-xs" onclick="editDepStatus('${d.id}')">Edit</button></td></tr>`).join('');}

function sendAutoMsg(userId, userName, text){const db=DB.get();db.messages=db.messages||[];db.messages.push({id:'msg_'+Date.now()+'_auto',fromUserId:'admin',fromName:'Admin',toUserId:userId,fromAdmin:true,text,date:new Date().toISOString(),readByUser:false,readByAdmin:true});DB.save(db);}

function appDep(id){const db=DB.get();const dep=db.deposits.find(d=>d.id===id);if(!dep||dep.status!=='pending')return t('!','Already processed');dep.status='approved';const us=DB.getUsers();const ui=us.findIndex(u=>u.id===dep.userId);if(ui>=0){us[ui].balance=parseFloat(((us[ui].balance||0)+dep.amount).toFixed(4));DB.saveUsers(us);}DB.save(db);sendAutoMsg(dep.userId,dep.userName,`\u2705 Your deposit of $${dep.amount} has been approved and added to your balance successfully! Your new balance has been updated.`);t('OK','$'+dep.amount+' approved for '+dep.userName+' — user notified');refreshAll();}
function rejDep(id){const db=DB.get();const dep=db.deposits.find(d=>d.id===id);if(!dep)return;dep.status='rejected';DB.save(db);sendAutoMsg(dep.userId,dep.userName,`\u274C Your deposit request of $${dep.amount} has been rejected. Please contact support if you believe this is an error.`);t('X','Deposit rejected — user notified');refreshAll();}
function viewDep(id){const db=DB.get();const dep=db.deposits.find(d=>d.id===id);if(!dep)return;const imgHtml=dep.docData?`<div style="margin-top:14px;"><div style="font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);margin-bottom:7px;">Payment Receipt</div><img src="${dep.docData}" style="max-width:100%;border-radius:var(--r);border:1px solid var(--b1);"/></div>`:'<div style="color:var(--t4);margin-top:10px;padding:10px;background:var(--bg3);border-radius:var(--r);text-align:center;">No document attached</div>';document.getElementById('dep-view-body').innerHTML=`<div class="sum-row"><span class="sk">User</span><span style="font-weight:700;">${dep.userName}</span></div><div class="sum-row"><span class="sk">Email</span><span>${dep.userEmail||'-'}</span></div><div class="sum-row"><span class="sk">Phone</span><span style="font-family:var(--mn);">${dep.phone}</span></div><div class="sum-row"><span class="sk">Method</span><span class="badge bb">${dep.method==='fastpay'?'Fast Pay':'FIB'}</span></div><div class="sum-row"><span class="sk">Amount</span><span style="font-family:var(--mn);color:var(--ye);font-weight:700;">$${dep.amount}</span></div><div class="sum-row"><span class="sk">Status</span><span class="badge ${dep.status==='pending'?'bo':dep.status==='approved'?'bg':'br'}">${dep.status}</span></div><div class="sum-row"><span class="sk">Date</span><span style="font-size:.75rem;color:var(--t3);">${new Date(dep.date).toLocaleString()}</span></div>${imgHtml}${dep.status==='pending'?`<div style="display:flex;gap:8px;margin-top:16px;"><button class="btn btn-gr" style="flex:1;" onclick="appDep('${dep.id}');document.getElementById('dep-view-ovl').classList.remove('show');">Approve</button><button class="btn btn-re" onclick="rejDep('${dep.id}');document.getElementById('dep-view-ovl').classList.remove('show');">Reject</button></div>`:''}`;document.getElementById('dep-view-ovl').classList.add('show');}
function editDepStatus(id){const db=DB.get();const dep=db.deposits.find(d=>d.id===id);if(!dep)return;const ns=prompt('New status (pending/approved/rejected):',dep.status);if(!ns||!['pending','approved','rejected'].includes(ns))return;const na=parseFloat(prompt('Amount:',''+dep.amount)||''+dep.amount);const wasApp=dep.status==='approved';const nowApp=ns==='approved';dep.status=ns;dep.amount=na||dep.amount;const us=DB.getUsers();const ui=us.findIndex(u=>u.id===dep.userId);if(ui>=0){if(!wasApp&&nowApp){us[ui].balance=parseFloat(((us[ui].balance||0)+dep.amount).toFixed(4));sendAutoMsg(dep.userId,dep.userName,`\u2705 Your deposit of $${dep.amount} has been approved and added to your balance successfully!`);}if(wasApp&&!nowApp)us[ui].balance=Math.max(0,parseFloat(((us[ui].balance||0)-dep.amount).toFixed(4)));DB.saveUsers(us);}DB.save(db);t('OK','Updated');refreshAll();}
function renderTxPage(db){const txs=(db.transactions||[]).slice().reverse();document.getElementById('all-tx-body').innerHTML=!txs.length?'<tr><td colspan="7" style="color:var(--t3);padding:13px;text-align:center;">No transactions</td></tr>':txs.map(tx=>`<tr><td><strong>${tx.userName}</strong></td><td>${tx.coinName}</td><td><span class="badge ${tx.type==='buy'?'bg':'br'}">${tx.type.toUpperCase()}</span></td><td style="font-family:var(--mn);">${tx.coinsAmt.toFixed(4)}</td><td style="font-family:var(--mn);">$${tx.usdAmt.toFixed(2)}</td><td style="color:var(--t3);font-family:var(--mn);">$${tx.price.toFixed(4)}</td><td style="color:var(--t3);font-size:.72rem;">${new Date(tx.date).toLocaleString()}</td></tr>`).join('');}
function renderCoinsPage(db){const g=document.getElementById('coins-admin-grid');if(!g)return;g.innerHTML=!db.coins.length?'<div style="color:var(--t3);">No coins yet</div>':db.coins.map(c=>`<div class="cac"><div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;"><div style="width:42px;height:42px;border-radius:50%;background:${c.color}18;border:2px solid ${c.color}33;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;">${c.icon}</div><div style="flex:1;"><div style="font-weight:700;">${c.name}</div><div style="color:var(--t3);font-size:.75rem;">${c.symbol}</div></div><div style="font-family:var(--mn);font-weight:700;color:${c.color};">$${c.price.toFixed(4)}</div></div><div style="font-size:.72rem;color:var(--t3);margin-bottom:10px;">Supply: ${(c.supply||0).toLocaleString()} · ${(c.candles||[]).length} pts</div><div style="display:flex;gap:5px;"><button class="btn btn-gh btn-xs" style="flex:1;" onclick="openEditCoin('${c.id}')">Edit</button><button class="btn btn-ye btn-xs" onclick="qPriceEdit('${c.id}')">Price</button><button class="btn btn-re btn-xs" onclick="delCoin('${c.id}')">Delete</button></div></div>`).join('');}
function delCoin(id){if(!confirm('Delete this coin?'))return;const db=DB.get();db.coins=db.coins.filter(c=>c.id!==id);DB.save(db);t('OK','Coin deleted');refreshAll();}
function qPriceEdit(id){const db=DB.get();const c=db.coins.find(x=>x.id===id);if(!c)return;const inp=prompt('New price for '+c.name+' (current: $'+c.price.toFixed(4)+')\nMax +/- $0.10',''+c.price.toFixed(4));if(inp===null)return;const np=parseFloat(inp);if(isNaN(np)||np<=0)return t('!','Invalid price');if(Math.abs(np-c.price)>.10)return t('!','Max $0.10 per move');ensureC(c);c.candles.push({time:Math.floor(Date.now()/1000),value:np});c.price=np;DB.save(db);t('OK',c.name+' updated');refreshAll();}
function buildIconGrid(){document.getElementById('icon-grid').innerHTML=ICONS.map(ic=>`<div class="ico ${ic===newIco?'sel':''}" onclick="pickIco(this,'${ic}')">${ic}</div>`).join('');}
function buildClrRow(){document.getElementById('clr-row').innerHTML=COLORS.map(col=>`<div class="clr ${col===newClr?'sel':''}" style="background:${col};" onclick="pickClr('${col}')"></div>`).join('');}
function pickIco(el,ic){newIco=ic;document.querySelectorAll('.ico').forEach(e=>e.classList.remove('sel'));el.classList.add('sel');updPrev();}
function pickClr(col){newClr=col;document.querySelectorAll('.clr').forEach(e=>e.classList.toggle('sel',rgbH(e.style.backgroundColor)===col));updPrev();}
function rgbH(rgb){const r=rgb.match(/\d+/g);if(!r||r.length<3)return rgb;return'#'+r.slice(0,3).map(x=>parseInt(x).toString(16).padStart(2,'0')).join('');}
function updPrev(){const nm=gv('cn-nm')||'My Coin';const sy=(gv('cn-sy')||'MYC').toUpperCase();const pr=parseFloat(gv('cn-pr'))||.01;document.getElementById('prev-ic').textContent=newIco;document.getElementById('prev-ic').style.cssText=`background:${newClr}18;border:2px solid ${newClr}44;width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;`;document.getElementById('prev-nm').textContent=nm;document.getElementById('prev-sy').textContent=sy;document.getElementById('prev-pr').textContent='$'+pr.toFixed(4);}
function openCoinModal(){document.getElementById('coin-modal-ttl').textContent='Create New Coin';document.getElementById('coin-save-lbl').textContent='Launch Coin';document.getElementById('cn-edit-id').value='';document.getElementById('cn-nm').value='';document.getElementById('cn-sy').value='';document.getElementById('cn-pr').value='0.0100';document.getElementById('cn-sup').value='10000000';editingCoinId=null;newIco='\u20BF';newClr='#f0b90b';buildIconGrid();buildClrRow();updPrev();document.getElementById('coin-ovl').classList.add('show');}
function openEditCoin(id){const db=DB.get();const c=db.coins.find(x=>x.id===id);if(!c)return;document.getElementById('coin-modal-ttl').textContent='Edit Coin';document.getElementById('coin-save-lbl').textContent='Save';document.getElementById('cn-edit-id').value=id;document.getElementById('cn-nm').value=c.name;document.getElementById('cn-sy').value=c.symbol;document.getElementById('cn-pr').value=c.price.toFixed(4);document.getElementById('cn-sup').value=c.supply||10000000;editingCoinId=id;newIco=c.icon||'\u20BF';newClr=c.color||'#f0b90b';buildIconGrid();buildClrRow();updPrev();document.getElementById('coin-ovl').classList.add('show');}
function closeCoinModal(){document.getElementById('coin-ovl').classList.remove('show');}
function saveCoin(){const nm=gv('cn-nm').trim();const sy=gv('cn-sy').trim().toUpperCase();const pr=parseFloat(gv('cn-pr'));const sup=parseInt(gv('cn-sup'))||10000000;if(!nm)return t('!','Name required');if(!sy||sy.length<2)return t('!','Symbol 2-6 letters');if(!pr||pr<=0)return t('!','Invalid price');const db=DB.get();if(editingCoinId){const ci=db.coins.findIndex(c=>c.id===editingCoinId);if(ci<0)return;const c=db.coins[ci];const op=c.price;c.name=nm;c.symbol=sy;c.supply=sup;c.icon=newIco;c.color=newClr;if(Math.abs(pr-op)>.10)return t('!','Max $0.10 change');if(pr!==op){ensureC(c);c.candles.push({time:Math.floor(Date.now()/1000),value:pr});c.price=pr;}DB.save(db);closeCoinModal();t('OK',nm+' updated!');}else{if(db.coins.find(c=>c.symbol===sy))return t('!','Symbol taken');const now=Math.floor(Date.now()/1000);const candles=[];for(let i=0;i<12;i++){const t2=now-(12-i)*1800;const v=pr*(.94+Math.random()*.12);candles.push({time:t2,value:v});}candles[11].value=pr;db.coins.push({id:sy.toLowerCase()+'_'+Date.now(),name:nm,symbol:sy,price:pr,supply:sup,color:newClr,icon:newIco,candles,created:Date.now()});DB.save(db);closeCoinModal();t('OK',nm+' launched!');}refreshAll();}
function populatePriceSel(db){const sel=document.getElementById('price-sel');if(!sel)return;const cur=sel.value;sel.innerHTML='<option value="">-- Select Coin --</option>'+(db.coins||[]).map(c=>`<option value="${c.id}">${c.name} (${c.symbol}) -- $${c.price.toFixed(4)}</option>`).join('');if(cur&&db.coins.find(c=>c.id===cur))sel.value=cur;}
function loadPriceCtrl(){const id=document.getElementById('price-sel').value;if(!id)return;selCoinId=id;const db=DB.get();const c=db.coins.find(x=>x.id===id);if(!c)return;ensureC(c);DB.save(db);document.getElementById('pc-name').textContent=c.name+'/USD';document.getElementById('pc-price').textContent='$'+c.price.toFixed(4);document.getElementById('ctrl-big').textContent='$'+c.price.toFixed(4);document.getElementById('ctrl-np').value=c.price.toFixed(4);buildAdminChart(c);}
function buildAdminChart(c){if(typeof LightweightCharts==='undefined'){const con=document.getElementById('admin-chart');if(con)con.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:380px;color:#707a8a;font-size:.85rem;">⚠ Chart library failed to load. Refresh the page.</div>';return;}const con=document.getElementById('admin-chart');con.innerHTML='';if(ALC){try{ALC.remove();}catch(e){}ALC=null;}ALC=LightweightCharts.createChart(con,{width:con.clientWidth,height:380,layout:{background:{color:'#060a12'},textColor:'#707a8a'},grid:{vertLines:{color:'rgba(255,255,255,.022)'},horzLines:{color:'rgba(255,255,255,.022)'}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:'rgba(255,255,255,.06)'},timeScale:{borderColor:'rgba(255,255,255,.06)',timeVisible:true}});ALS=ALC.addLineSeries({color:'#f0b90b',lineWidth:2,crosshairMarkerVisible:true,lastValueVisible:true,priceLineVisible:true});setChartData(c);const obs=new ResizeObserver(()=>{if(ALC)ALC.resize(con.clientWidth,380);});obs.observe(con);}
function setChartData(c){if(!ALS||typeof LightweightCharts==='undefined')return;const s=c.candles.slice().sort((a,b)=>a.time-b.time);const d=[];const seen=new Set();s.forEach(x=>{if(!seen.has(x.time)){seen.add(x.time);d.push({time:x.time,value:x.value||x.close||c.price});}});if(d.length)ALS.setData(d);ALC.timeScale().fitContent();}
function pollChart(){if(!selCoinId)return;const db=DB.get();const c=db.coins.find(x=>x.id===selCoinId);if(!c)return;document.getElementById('pc-price').textContent='$'+c.price.toFixed(4);document.getElementById('ctrl-big').textContent='$'+c.price.toFixed(4);setChartData(c);}
function setAdminPrice(){if(!selCoinId)return t('!','Select a coin');const db=DB.get();const c=db.coins.find(x=>x.id===selCoinId);if(!c)return;const np=parseFloat(gv('ctrl-np'));if(isNaN(np)||np<=0)return t('!','Invalid price');if(Math.abs(np-c.price)>.10)return t('!','Max $0.10');ensureC(c);c.candles.push({time:Math.floor(Date.now()/1000),value:np});c.price=np;DB.save(db);document.getElementById('ctrl-big').textContent='$'+np.toFixed(4);document.getElementById('pc-price').textContent='$'+np.toFixed(4);setChartData(c);t('OK',c.name+' = $'+np.toFixed(4));populatePriceSel(DB.get());}
function qMove(dir,sz){if(!selCoinId)return t('!','Select coin');const db=DB.get();const c=db.coins.find(x=>x.id===selCoinId);if(!c)return;const pct={s:.003,m:.015}[sz]||.01;const delta=c.price*pct*(dir==='up'?1:-1);const np=Math.max(.0001,parseFloat((c.price+delta).toFixed(6)));if(Math.abs(np-c.price)>.10)return t('!','Exceeds $0.10');ensureC(c);c.candles.push({time:Math.floor(Date.now()/1000),value:np});c.price=np;DB.save(db);document.getElementById('ctrl-big').textContent='$'+np.toFixed(4);document.getElementById('ctrl-np').value=np.toFixed(4);document.getElementById('pc-price').textContent='$'+np.toFixed(4);setChartData(c);t(dir==='up'?'+':'-',c.name+' = $'+np.toFixed(4));populatePriceSel(db);}
function renderUsersPage(){const us=DB.getUsers();document.getElementById('users-badge').textContent=us.length+' users';document.getElementById('users-body').innerHTML=!us.length?'<tr><td colspan="6" style="color:var(--t3);padding:13px;text-align:center;">No users registered yet</td></tr>':us.map(u=>`<tr><td><strong>${u.name}</strong></td><td>${u.email}</td><td>${u.phone}</td><td style="color:var(--ye);font-family:var(--mn);font-weight:700;">$${(u.balance||0).toFixed(2)}</td><td style="color:var(--t3);font-size:.73rem;">${new Date(u.joined).toLocaleDateString()}</td><td><button class="btn btn-gh btn-xs" onclick="openUE('${u.id}')">Edit</button></td></tr>`).join('');}
function openUE(id){const us=DB.getUsers();const u=us.find(x=>x.id===id);if(!u)return;document.getElementById('ue-id').value=id;document.getElementById('ue-name').value=u.name;document.getElementById('ue-email').value=u.email;document.getElementById('ue-phone').value=u.phone;document.getElementById('ue-bal').value=(u.balance||0).toFixed(2);document.getElementById('ue-ovl').classList.add('show');}
function saveUserEdit(){const id=gv('ue-id');const us=DB.getUsers();const ui=us.findIndex(u=>u.id===id);if(ui<0)return;us[ui].name=gv('ue-name');us[ui].email=gv('ue-email');us[ui].phone=gv('ue-phone');us[ui].balance=parseFloat(gv('ue-bal'))||0;DB.saveUsers(us);const db=DB.get();const ai=db.users.findIndex(u=>u.id===id);if(ai>=0){db.users[ai].name=us[ui].name;db.users[ai].email=us[ui].email;db.users[ai].phone=us[ui].phone;db.users[ai].balance=us[ui].balance;}DB.save(db);document.getElementById('ue-ovl').classList.remove('show');t('OK','User updated');refreshAll();}
function showNewMsgPanel(){
  const panel=document.getElementById('new-msg-panel');
  panel.style.display=panel.style.display==='none'?'block':'none';
  if(panel.style.display==='block'){
    const sel=document.getElementById('new-msg-uid');
    const us=DB.getUsers();
    sel.innerHTML=us.length?us.map(u=>`<option value="${u.id}">${u.name} — ${u.phone}</option>`).join(''):'<option value="">No users yet</option>';
  }
}
function startNewConvo(){
  const sel=document.getElementById('new-msg-uid');
  const uid=sel.value;if(!uid)return;
  const us=DB.getUsers();
  const u=us.find(x=>x.id===uid);if(!u)return;
  document.getElementById('new-msg-panel').style.display='none';
  openAdminThread(uid,u.name);
}
function renderAdminMsgs(){
  const db=DB.get();
  const msgs=db.messages||[];
  const searchEl=document.getElementById('msg-search');
  const q=(searchEl?searchEl.value:'').toLowerCase();
  const us=DB.getUsers();
  // All users who have messages with admin
  const msgUserIds=[...new Set(msgs.map(m=>m.fromUserId==='admin'?m.toUserId:m.fromUserId))].filter(id=>id!=='admin');
  const el=document.getElementById('admin-msg-list');
  let filtered=msgUserIds;
  if(q){filtered=msgUserIds.filter(uid=>{const u=us.find(x=>x.id===uid);return u&&(u.name.toLowerCase().includes(q)||u.email.toLowerCase().includes(q)||u.phone.includes(q));});}
  if(!filtered.length){
    el.innerHTML=`<div style="padding:16px;color:var(--t4);font-size:.8rem;text-align:center;">${q?'No matching users':'No conversations yet.<br>Click <strong>+ New</strong> to message a user.'}</div>`;
    return;
  }
  el.innerHTML=filtered.map(uid=>{
    const allMsgs=msgs.filter(m=>m.fromUserId===uid||m.toUserId===uid).sort((a,b)=>new Date(a.date)-new Date(b.date));
    const last=allMsgs.slice(-1)[0];
    const unread=msgs.filter(m=>m.fromUserId===uid&&m.toUserId==='admin'&&!m.readByAdmin).length;
    const u=us.find(x=>x.id===uid);
    const uname=u?u.name:(last?last.fromName:uid);
    return`<div class="mla-item ${activeMsgUser===uid?'on':''} ${unread?'unread':''}" onclick="openAdminThread('${uid}','${esc(uname)}')" style="cursor:pointer;"><div class="mla-av">${uname[0]||'?'}</div><div style="flex:1;min-width:0;"><div class="mla-name">${uname}${unread?` <span style="background:var(--re);color:#fff;font-size:.57rem;padding:1px 5px;border-radius:99px;">${unread}</span>`:''}</div><div class="mla-prev">${last?last.text.slice(0,38):'Start a conversation...'}</div></div><div class="mla-time">${last?tAgo(last.date):''}</div></div>`;
  }).join('');
}
function openAdminThread(uid,uname){activeMsgUser=uid;const db=DB.get();const msgs=(db.messages||[]).filter(m=>m.fromUserId===uid||m.toUserId===uid).sort((a,b)=>new Date(a.date)-new Date(b.date));msgs.forEach(m=>{if(m.fromUserId===uid&&m.toUserId==='admin')m.readByAdmin=true;});DB.save(db);const area=document.getElementById('admin-msg-chat');const un=DB.getUsers().find(u=>u.id===uid);const email=un?un.email:'';const bal=un?`$${(un.balance||0).toFixed(2)}`:'';area.innerHTML=`<div class="mca-hdr"><div class="mca-av">${uname[0]}</div><div><div class="mca-name">${uname}</div><div class="mca-email">${email}${bal?`  ·  <span style='color:var(--ye);font-family:var(--mn);font-size:.72rem;'>Bal: ${bal}</span>`:''}</div></div><div style='margin-inline-start:auto;'><button class='btn btn-gh btn-xs' onclick='openAdminThread("${uid}","${esc(uname)}")'>↻ Refresh</button></div></div><div class="mca-body" id="mca-body">${!msgs.length?'<div style="text-align:center;color:var(--t4);margin:auto;padding:20px;">No messages yet</div>':msgs.map(m=>`<div><div class="bubble ${m.fromAdmin?'adm-sent':'user-sent'}">${escH(m.text)}</div><div class="btime">${new Date(m.date).toLocaleTimeString()}</div></div>`).join('')}</div><div class="mca-foot"><textarea id="admin-inp" placeholder="Reply to ${uname}..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAdminMsg('${uid}','${esc(uname)}');}"></textarea><button class="btn btn-ye btn-sm" onclick="sendAdminMsg('${uid}','${esc(uname)}')">Send</button></div>`;const b=document.getElementById('mca-body');if(b)b.scrollTop=b.scrollHeight;renderAdminMsgs();}
function sendAdminMsg(toUid,toName){const inp=document.getElementById('admin-inp');if(!inp)return;const text=inp.value.trim();if(!text)return;const db=DB.get();db.messages=db.messages||[];db.messages.push({id:'msg_'+Date.now(),fromUserId:'admin',fromName:'Admin',toUserId:toUid,fromAdmin:true,text,date:new Date().toISOString(),readByUser:false,readByAdmin:true});DB.save(db);inp.value='';openAdminThread(toUid,toName);}
function tAgo(date){const d=(Date.now()-new Date(date))/1000;if(d<60)return'now';if(d<3600)return Math.floor(d/60)+'m';if(d<86400)return Math.floor(d/3600)+'h';return Math.floor(d/86400)+'d';}
function escH(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}
function gv(id){return(document.getElementById(id)||{value:''}).value;}
function t(icon,msg){document.getElementById('tic').textContent=icon;document.getElementById('tmsg').textContent=msg;const el=document.getElementById('toast');el.classList.add('show');clearTimeout(window._tt);window._tt=setTimeout(()=>el.classList.remove('show'),3500);}
document.getElementById('admin-app').style.display='none';
</script>
</body>
</html>